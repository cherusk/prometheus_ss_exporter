name: Build and Release Docker Image

# Trigger on published releases or manual workflow dispatch
on:
  release:
    types: [published]  # Only trigger on first publication, not edits
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., 1.2.3)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io/cherusk
  IMAGE_NAME: prometheus_ss_exporter

jobs:
  # Pre-release validation step
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      should-proceed: ${{ steps.validation.outputs.should-proceed }}
      version: ${{ steps.validation.outputs.version }}
      is-latest: ${{ steps.validation.outputs.is-latest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version validation

      - name: Validate release and extract version
        id: validation
        run: |
          # Extract version from release event or manual input
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            IS_LATEST="true"  # Assume release events create latest
          else
            echo "Manual release tags not supported yet."
            exit 2
          fi

          # Validate semantic versioning format (1.2.3 or 1.2.3-beta)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: 1.2.3 or 1.2.3-beta"
            exit 1
          fi

          # Validate that the tag exists (for manual dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if ! git rev-parse --verify "$VERSION" >/dev/null 2>&1; then
              echo "‚ùå Tag $VERSION does not exist in repository"
              exit 1
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should-proceed=true" >> $GITHUB_OUTPUT
          echo "is-latest=$IS_LATEST" >> $GITHUB_OUTPUT
          echo "‚úÖ Release validation passed for version: $VERSION"
          echo "üìã Latest tag: $IS_LATEST"

  # Main build and push job with enhanced security and caching
  build-and-push-image:
    runs-on: ubuntu-latest
    needs: [validate-release]
    if: needs.validate-release.outputs.should-proceed == 'true'
    env:
      VERSION: ${{ needs.validate-release.outputs.version }}
      IMAGE_NAME: prometheus-ss-exporter
    permissions:
      contents: read
      packages: write
      security-events: write
      attestations: write
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
      tags: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx with enhanced features
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Set up Nix builder environment for release
        run: |
          echo "üèóÔ∏è Setting up Nix container build system for release..."
          chmod +x ./build-container-nix.sh

          echo "Release build environment configured:"
          echo "  Version: $VERSION"
          echo "  Image: $IMAGE_NAME"

      - name: Build optimized Nix container for release
        run: |
          echo "üöÄ Building optimized Nix container for release..."

          # Build the optimized container using our enhanced script
          bash ./build-container-nix.sh \
            --version "$VERSION" \
            --name "$IMAGE_NAME"

          echo "‚úÖ Nix optimized build completed"

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push optimized image to registry for metadata wrapper
        run: |
          echo "üì§ Pushing optimized image to registry for metadata wrapper..."
          
          # Tag the locally built image for the registry
          docker tag ${{ env.IMAGE_NAME }}:${{ env.VERSION }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          
          # Push to make it available for the metadata wrapper step
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          
          echo "‚úÖ Optimized image pushed to ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          echo "üê≥ Now available for metadata wrapper to use as base image"

      - name: Extract comprehensive metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Primary version tag
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            # Minor version tag for backwards compatibility
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            # Major version tag for LTS tracking
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            # Latest tag only for stable releases (no pre-release suffix)
            type=raw,value=latest,enable=${{ needs.validate-release.outputs.is-latest == 'true' && !contains(needs.validate-release.outputs.version, '-') }}
          labels: |
            # OCI-compliant labels
            org.opencontainers.image.title=Prometheus Socket Statistics Exporter
            org.opencontainers.image.description=Exporter that gathers Operating System Network Socket Statistics as Metrics using pyroute2
            org.opencontainers.image.url=https://github.com/cherusk/prometheus_ss_exporter
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ needs.validate-release.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.documentation=https://github.com/cherusk/prometheus_ss_exporter#readme
            # Custom labels for our use case
            maintainer=Matthias Tafelmeier <matthias.tafelmeier@gmx.net>
            prometheus.exporter.type=socket_statistics
            prometheus.exporter.port=8020

      - name: Apply OCI metadata and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.metadata
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          
          # Use our already-built Nix image as the base (now available in registry)
          # This creates a new layer that just adds the metadata/labels
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          
          # Enhanced security and caching options
          cache-from: type=gha,scope=release-build
          cache-to: type=gha,mode=max,scope=release-build
          
          # Security scanning
          provenance: true

      - name: Scan final image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-release.outputs.version }}"
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: "security-scan"

      - name: Generate security summary
        run: |
          echo "üìä Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability scan: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security report uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY

  # Release confirmation and summary
  release-summary:
    runs-on: ubuntu-latest
    needs: [validate-release, build-and-push-image]
    if: always() && needs.validate-release.outputs.should-proceed == 'true'
    steps:
      - name: Create comprehensive release summary
        run: |
          echo "## üöÄ Docker Image Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Release Information" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.validate-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ needs.build-and-push-image.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üì¶ Published Docker Images" >> $GITHUB_STEP_SUMMARY
